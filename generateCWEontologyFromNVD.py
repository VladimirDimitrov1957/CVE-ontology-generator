import urllib.request
import json
import re
from datetime import datetime

def generateShell():
        with open(owl_fn, mode='w', encoding='utf-8') as out_file:
                out_file.write("""@prefix : <http://www.semanticweb.org/cwe#> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xml: <http://www.w3.org/XML/1998/namespace> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@base <http://www.semanticweb.org/cwe> .

<http://www.semanticweb.org/cwe> rdf:type owl:Ontology .

###  http://www.semanticweb.org/cwe#CWE
:CWE rdf:type owl:Class .

""")

def generateCWEsForCVE(ptd, outFile, cwes):
        global count
        for d in ptd:
                for e in d["description"]:
                        outFile.write("\r:" + e["value"] + "\r\trdf:type owl:NamedIndividual ;\r\trdf:type :CWE .")
                        count = count + 1
        
def generateCWEs():
        global count
        generateShell()
        print("Load json dictionaries for the years:")
        with open(owl_fn, "a", encoding="utf-8") as outFile:
                
                with open("data/nvdcve-1.1-modified.json", "r", encoding="utf-8") as inFile:
                        d = json.loads(inFile.read())
                modified = set()
                cwes = set()
                for item in d["CVE_Items"]:
                        cveID = item["cve"]["CVE_data_meta"]["ID"]
                        generateCWEsForCVE(item["cve"]["problemtype"]["problemtype_data"], outFile, cwes)
                                
                
                feeds = ["modified"]
                feeds.extend(map(str, range(2002, datetime.now().year + 1)))
                for year in feeds:
                        print(year)
                        try:
                                with open("data/nvdcve-1.1-" + year + ".json", "r", encoding="utf-8") as inFile:
                                        d = json.loads(inFile.read())
                                for item in d["CVE_Items"]:
                                        cveID = item["cve"]["CVE_data_meta"]["ID"]
                                        if cveID in modified: continue
                                        generateCWEsForCVE(item["cve"]["problemtype"]["problemtype_data"], outFile, cwes)
                        except Exception as exc:
                                print(exc)
                                next
                                
        print(f"CWEs: {count}")                                
        print("Loaded all dictionaries")

def main():
        print("CWE Ontology Generator from NVD, Version 3.0")
        start = datetime.now()
        print(start)
        generateCWEs()
        end = datetime.now()
        print(end)
        print(f"Elapsed: {end - start}")

owl_fn = "results/cwe.ttl" # CWE ontology file name
count = 0

if __name__ == "__main__":
    main()
